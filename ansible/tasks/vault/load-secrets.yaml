---
# Task riutilizzabile per caricare segreti da Vault
# Usa vault_secrets_map definito nel playbook chiamante

- name: Validate vault_secrets_map is defined
  ansible.builtin.assert:
    that:
      - vault_secrets_map is defined
      - vault_secrets_map | length > 0
    fail_msg: "vault_secrets_map must be defined and not empty"

- name: Initialize vault secrets storage
  ansible.builtin.set_fact:
    vault_secrets_loaded: {}
  run_once: true

- name: Load secrets from Vault for each category
  ansible.builtin.include_tasks: load-secrets-category.yaml
  loop: "{{ vault_secrets_map | dict2items }}"
  loop_control:
    loop_var: category
  run_once: true

- name: Display loaded categories
  ansible.builtin.debug:
    msg: "âœ“ Loaded {{ vault_secrets_loaded.keys() | list | length }} secret categories: {{ vault_secrets_loaded.keys() | list }}"
  run_once: true
