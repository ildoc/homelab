---
- name: Initialize category storage
  ansible.builtin.set_fact:
    category_secrets: {}

- name: Load each secret in category {{ category.key }}
  ansible.builtin.set_fact:
    category_secrets: >-
      {{
        category_secrets | combine({
          secret_item.key: lookup('community.hashi_vault.hashi_vault', secret_item.value)
        })
      }}
  loop: "{{ category.value | dict2items }}"
  loop_control:
    loop_var: secret_item
    label: "{{ category.key }}.{{ secret_item.key }}"
  no_log: true

- name: Store category in vault_secrets_loaded
  ansible.builtin.set_fact:
    vault_secrets_loaded: "{{ vault_secrets_loaded | combine({category.key: category_secrets}) }}"
