- name: Skip system upgrade if already on Proxmox VE 9
  debug:
    msg: "System already upgraded to Proxmox VE 9 - skipping dist-upgrade"
  when: already_upgraded | default(false)

- name: Perform distribution upgrade to Proxmox VE 9
  when: not (already_upgraded | default(false))
  environment:
    DEBIAN_FRONTEND: noninteractive
    APT_LISTCHANGES_FRONTEND: none
  block:
    - name: Execute distribution upgrade
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes
      register: dist_upgrade_result
      timeout: 7200  # 2 hours timeout
      retries: 2
      delay: 30

    - name: Check upgrade results
      debug:
        msg: |
          Distribution upgrade completed.
          Changed: {{ dist_upgrade_result.changed }}
          Stdout lines: {{ dist_upgrade_result.stdout_lines | length if dist_upgrade_result.stdout_lines is defined else 0 }}

- name: Run post-upgrade pve8to9 check
  command: pve8to9 --full
  register: post_upgrade_check
  changed_when: false
  failed_when: false

- name: Save post-upgrade check results
  copy:
    content: |
      Post-upgrade pve8to9 results ({{ ansible_date_time.iso8601 }}):
      Return code: {{ post_upgrade_check.rc }}
      STDOUT:
      {{ post_upgrade_check.stdout }}
      STDERR:
      {{ post_upgrade_check.stderr }}
    dest: "/root/pve8to9-post-upgrade-{{ ansible_date_time.date }}.log"
