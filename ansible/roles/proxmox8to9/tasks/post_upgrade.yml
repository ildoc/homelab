- name: Get final Proxmox VE version
  command: pveversion
  register: final_pve_version
  changed_when: false

- name: Display upgrade completion message
  debug:
    msg: |
      Proxmox VE upgrade process completed!
      
      Final version: {{ final_pve_version.stdout }}
      
      {% if already_upgraded | default(false) %}
      System was already upgraded to version 9.
      {% endif %}
      
      IMPORTANT: A reboot is recommended to ensure all services use the new kernel.
      
      Post-upgrade pve8to9 check return code: {{ post_upgrade_check.rc }}
      Check results saved to: /root/pve8to9-post-upgrade-{{ ansible_date_time.date }}.log

- name: Reboot system to complete upgrade
  reboot:
    reboot_timeout: 600
    connect_timeout: 20
    test_command: pveversion
  when: 
    - proxmox_upgrade_auto_reboot | default(false)
    - not (already_upgraded | default(false))

- name: Prompt for manual reboot (if upgrade was performed)
  debug:
    msg: |
      ATTENZIONE: Il sistema deve essere riavviato per completare l'upgrade.
      
      Esegui manualmente:
      systemctl reboot
      
      Dopo il riavvio, verifica la versione con:
      pveversion
  when: 
    - not (proxmox_upgrade_auto_reboot | default(false))
    - not (already_upgraded | default(false))

- name: No reboot needed message
  debug:
    msg: |
      Sistema già aggiornato a Proxmox VE 9.
      Un riavvio potrebbe comunque essere utile se non è stato fatto recentemente.
      
      Versione corrente: {{ final_pve_version.stdout }}
  when: already_upgraded | default(false)
