---
- name: Get existing DNS records
  ansible.builtin.uri:
    url: "{{ pihole.api_url }}/api/customdns"
    method: GET
    headers:
      X-FTL-SID: "{{ pihole.api_key }}"
    return_content: true
  register: existing_dns_records

- name: Parse existing DNS records
  ansible.builtin.set_fact:
    existing_dns_map: "{{ existing_dns_records.json.customdns | default([]) | 
                          map(attribute='domain') | 
                          zip(existing_dns_records.json.customdns | default([]) | map(attribute='ip')) | 
                          map('reverse') | list }}"

- name: Build desired DNS records map
  ansible.builtin.set_fact:
    desired_dns_map: "{{ pihole.dns_records | 
                         map(attribute='domain') | 
                         zip(pihole.dns_records | map(attribute='ip')) | 
                         map('reverse') | list }}"

- name: Identify DNS records to add
  ansible.builtin.set_fact:
    dns_to_add: "{{ desired_dns_map | difference(existing_dns_map) }}"

- name: Identify DNS records to remove
  ansible.builtin.set_fact:
    dns_to_remove: "{{ existing_dns_map | difference(desired_dns_map) }}"

- name: Add new DNS records
  ansible.builtin.uri:
    url: "{{ pihole.api_url }}/api/customdns"
    method: POST
    headers:
      X-FTL-SID: "{{ pihole.api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      ip: "{{ item[0] }}"
      domain: "{{ item[1] }}"
    status_code: [200, 201]
  loop: "{{ dns_to_add }}"
  when: dns_to_add | length > 0
  register: dns_add_result

- name: Remove obsolete DNS records
  ansible.builtin.uri:
    url: "{{ pihole.api_url }}/api/customdns"
    method: DELETE
    headers:
      X-FTL-SID: "{{ pihole.api_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      ip: "{{ item[0] }}"
      domain: "{{ item[1] }}"
    status_code: [200, 204]
  loop: "{{ dns_to_remove }}"
  when: dns_to_remove | length > 0
  register: dns_remove_result

- name: Display DNS changes summary
  ansible.builtin.debug:
    msg:
      - "DNS records added: {{ dns_to_add | length }}"
      - "DNS records removed: {{ dns_to_remove | length }}"
  when: (dns_to_add | length > 0) or (dns_to_remove | length > 0)
