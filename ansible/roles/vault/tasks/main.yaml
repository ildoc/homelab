---
- name: Install docker
  ansible.builtin.include_tasks: "{{ tasks_dir }}/docker/install.yaml"

- name: Set variables
  ansible.builtin.set_fact:
    remote_path: ~/docker-compose.yml
    template_file: docker-compose.yml
    project_path: .

- name: Include update docker-compose
  ansible.builtin.include_tasks: "{{ tasks_dir }}/docker/update-compose.yaml"
  vars:
    update_compose_remote_path: "{{ remote_path }}"
    template_file_name: "{{ template_file }}"
    update_compose_project_path: "{{ project_path }}"

- name: Copy init-vault.sh
  ansible.builtin.template:
    src: init-vault.sh
    dest: ~/init-vault.sh
    mode: '0755'

- name: Read remote vault-config.json
  ansible.builtin.stat:
    path: ~/config/vault-config.json
  register: remote_config

- name: Read remote file content
  ansible.builtin.slurp:
    src: ~/config/vault-config.json
  register: remote_config_content
  when: remote_config.stat.exists

- name: Render template content
  ansible.builtin.set_fact:
    template_config_raw: "{{ lookup('template', 'vault-config.json') }}"

- name: Normalize template content to string
  ansible.builtin.set_fact:
    template_config_rendered: "{{ (template_config_raw | string).strip() }}"

- name: Set default remote content when file doesn't exist
  ansible.builtin.set_fact:
    remote_content_decoded: ""
  when: not remote_config.stat.exists

- name: Decode remote content when file exists
  ansible.builtin.set_fact:
    remote_content_decoded: "{{ (remote_config_content.content | b64decode | string).strip() }}"
  when: remote_config.stat.exists

- name: Check file content and set variables
  ansible.builtin.set_fact:
    config_different: "{{ not remote_config.stat.exists or (remote_content_decoded != template_config_rendered) }}"

- name: Are they different?
  ansible.builtin.debug:
    msg: "{{ config_different }}"

- name: Actions to do if files are different
  when: config_different
  block:
    - name: Ensures ~/config/ dir exists
      ansible.builtin.file:
        path: ~/config/
        state: directory
        mode: '0755'

    - name: Copy vault-config.json
      ansible.builtin.template:
        src: vault-config.json
        dest: ~/config/vault-config.json
        mode: '0644'
      register: config_copy_result

    - name: Exec docker-compose down
      community.docker.docker_compose_v2:
        project_src: .
        state: absent
      when: remote_config.stat.exists

    - name: Exec docker-compose up
      community.docker.docker_compose_v2:
        project_src: .
        state: present

- name: Wait for Vault to be ready
  ansible.builtin.uri:
    url: http://127.0.0.1:8200/v1/sys/health
    method: GET
    status_code: [200, 429, 472, 473, 501, 503]
  register: vault_health
  until: vault_health.status in [200, 429, 473, 501]
  retries: 10
  delay: 3
