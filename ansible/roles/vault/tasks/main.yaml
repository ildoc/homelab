# https://www.virtualizationhowto.com/2025/01/hashicorp-vault-docker-install-steps-kubernetes-not-required/


- name: Install docker
  ansible.builtin.include_tasks: "{{ tasks_dir }}/docker/install.yaml"

- name: Valorizza variabili
  ansible.builtin.set_fact:
    remote_path: ~/docker-compose.yml
    local_path: "{{ vault_files_path }}/docker-compose.yml"
    project_path: .

- name: Includi update docker docker-compose
  ansible.builtin.include_tasks: "{{ tasks_dir }}/docker/update-compose.yaml"
  vars:
    update_compose_remote_path: "{{ remote_path }}"
    update_compose_local_path: "{{ local_path }}"
    update_compose_project_path: "{{ project_path }}"

- name: Leggi il vault-config.json remoto
  ansible.builtin.stat:
    path: ~/config/vault-config.json
  register: remote_config

- name: Leggi il vault-config.json locale
  ansible.builtin.stat:
    path: "{{ vault_files_path }}/vault-config.json"
  register: local_config
  delegate_to: localhost

- name: Controlla i contenuti e imposta variabili
  ansible.builtin.set_fact:
    config_different: "{{ not remote_config.stat.exists or remote_config.stat.checksum != local_config.stat.checksum }}"

- name: Sono diversi?
  ansible.builtin.debug:
    msg: "{{ config_different }}"

- name: Esegui azioni Docker se il file è stato copiato o è diverso
  when: config_different
  block:
    - name: Ensures ~/config/ dir exists
      ansible.builtin.file:
        path: ~/config/
        state: directory
        mode: '0755'

    - name: Copia vault-config.json
      ansible.builtin.copy:
        src: "{{ vault_files_path }}/vault-config.json"
        dest: ~/config/vault-config.json
        mode: '0644'
      register: config_copy_result

    - name: Esegui docker-compose down
      community.docker.docker_compose_v2:
        project_src: .
        state: absent
      when: remote_file.stat.exists

    - name: Esegui docker-compose up
      community.docker.docker_compose_v2:
        project_src: .
        state: present
