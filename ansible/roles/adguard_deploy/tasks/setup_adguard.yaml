---
- name: Check what is using port 53
  ansible.builtin.shell: lsof -i :53 -t || true
  register: port_53_pids
  changed_when: false
  become: true

- name: Stop and disable systemd-resolved if running
  ansible.builtin.systemd:
    name: systemd-resolved
    state: stopped
    enabled: false
  when: port_53_pids.stdout != ""
  become: true

- name: Remove systemd-resolved stub listener
  ansible.builtin.lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: '^#?DNSStubListener='
    line: 'DNSStubListener=no'
    state: present
  when: port_53_pids.stdout != ""
  become: true

- name: Kill any remaining processes on port 53
  ansible.builtin.shell: "kill -9 {{ item }}"
  loop: "{{ port_53_pids.stdout_lines }}"
  when: port_53_pids.stdout != ""
  ignore_errors: true
  become: true

- name: Wait for port 53 to be free
  ansible.builtin.wait_for:
    port: 53
    state: stopped
    timeout: 30
  when: port_53_pids.stdout != ""

- name: Check if adguard container exists and its state
  ansible.builtin.shell: "docker ps -a --filter name=^adguard$ --format '{{ '{{' }}.State{{ '}}' }}' || echo 'none'"
  register: adguard_container_state
  changed_when: false

- name: Remove failed/created containers only
  ansible.builtin.shell: "docker rm -f adguard"
  when: adguard_container_state.stdout in ['created', 'exited']
  changed_when: true

- name: Create adguard work folder
  ansible.builtin.file:
    path: ~/adguard/work
    state: directory
    mode: '0755'
    recurse: true

- name: Create adguard config folder
  ansible.builtin.file:
    path: ~/adguard/conf
    state: directory
    mode: '0755'
    recurse: true

- name: Set variables
  ansible.builtin.set_fact:
    remote_path: ~/docker-compose.yml
    template_file: docker-compose.yml
    project_path: .

- name: Include update docker-compose
  ansible.builtin.include_tasks: "{{ tasks_dir }}/docker/update-compose.yaml"
  vars:
    update_compose_remote_path: "{{ remote_path }}"
    template_file_name: "{{ template_file }}"
    update_compose_project_path: "{{ project_path }}"
