---
# ======================================
# KESTRA FLOWS CI/CD
# ======================================
# Questo file viene incluso nella pipeline principale
# Gli stage devono essere dichiarati nel file padre

variables:
  KESTRA_URL: "https://kestra.local.ildoc.it"
  KESTRA_NAMESPACE: "homelab.infrastructure"
  KESTRA_DIR: "kestra-flows"
  # Vault configuration
  VAULT_ADDR: "https://vault.local.ildoc.it"
  VAULT_AUTH_PATH: "approle"

# Valida sintassi YAML dei flow (usa lo stage lint_quality esistente)
validate_kestra_flows:
  stage: lint_quality
  image: mikefarah/yq:latest
  needs: []
  script:
    - cd ${KESTRA_DIR}
    - |
      echo "Validating Kestra flow YAML syntax in ${KESTRA_DIR}..."
      ERROR=0
      
      for flow in _flows/**/*.yml; do
        if [ -f "$flow" ]; then
          echo "Checking $flow..."
          if ! yq eval '.' "$flow" > /dev/null 2>&1; then
            echo "‚ùå Invalid YAML: $flow"
            ERROR=1
          else
            echo "‚úì Valid: $flow"
          fi
        fi
      done
      
      if [ $ERROR -eq 1 ]; then
        echo ""
        echo "‚ùå Validation failed!"
        exit 1
      fi
      
      echo ""
      echo "‚úÖ All Kestra flows are valid"
  only:
    changes:
      - kestra-flows/_flows/**/*.yml

# Deploy Namespace Files (usa lo stage sync esistente)
deploy_kestra_namespace_files:
  stage: sync
  image: hashicorp/vault:latest
  needs: []
  before_script:
    - |
      echo "üîê Authenticating with Vault..."
      
      # Login to Vault usando AppRole
      VAULT_TOKEN=$(vault write -field=token auth/${VAULT_AUTH_PATH}/login \
        role_id="${VAULT_ROLE_ID}" \
        secret_id="${VAULT_SECRET_ID}")
      
      if [ -z "$VAULT_TOKEN" ]; then
        echo "‚ùå Failed to authenticate with Vault"
        exit 1
      fi
      
      export VAULT_TOKEN
      echo "‚úÖ Vault authentication successful"
      
      # Recupera credenziali Kestra
      echo "üì• Fetching Kestra credentials..."
      KESTRA_USER=$(vault kv get -field=username kubernetes/apps/kestra)
      KESTRA_PASS=$(vault kv get -field=password kubernetes/apps/kestra)
      
      if [ -z "$KESTRA_USER" ] || [ -z "$KESTRA_PASS" ]; then
        echo "‚ùå Failed to retrieve Kestra credentials from Vault"
        exit 1
      fi
      
      export KESTRA_USER
      export KESTRA_PASS
      echo "‚úÖ Kestra credentials retrieved"
      
      # Installa curl se necessario (l'immagine vault non lo ha di default)
      apk add --no-cache curl
  script:
    - cd ${KESTRA_DIR}
    - |
      echo "Deploying namespace files to ${KESTRA_NAMESPACE}..."
      
      # Trova tutti i file escluso _flows e file di config
      find . -type f \
        ! -path "./_flows/*" \
        ! -path "./.git/*" \
        ! -name ".gitignore" \
        ! -name "README.md" \
        | while read -r file; do
        
        # Rimuovi ./ iniziale
        clean_path="${file#./}"
        
        echo "üì§ Uploading: $clean_path"
        
        response=$(curl -s -w "\n%{http_code}" -X PUT \
          -u "${KESTRA_USER}:${KESTRA_PASS}" \
          -H "Content-Type: application/octet-stream" \
          --data-binary @"$file" \
          "${KESTRA_URL}/api/v1/namespaces/${KESTRA_NAMESPACE}/files?path=${clean_path}")
        
        http_code=$(echo "$response" | tail -n1)
        
        if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
          echo "‚úì Uploaded: $clean_path"
        else
          body=$(echo "$response" | head -n-1)
          echo "‚úó Failed: $clean_path (HTTP $http_code)"
          echo "Response: $body"
        fi
      done
      
      echo ""
      echo "‚úÖ Namespace files deployed"
  only:
    refs:
      - main
    changes:
      - kestra-flows/scripts/**/*
      - kestra-flows/queries/**/*
      - kestra-flows/configs/**/*
      - kestra-flows/templates/**/*
  environment:
    name: production

# Deploy Flows (usa lo stage sync esistente, dopo namespace files)
deploy_kestra_flows:
  stage: sync
  image: hashicorp/vault:latest
  needs:
    - job: deploy_kestra_namespace_files
      optional: true
  before_script:
    - |
      echo "üîê Authenticating with Vault..."
      
      # Login to Vault usando AppRole
      VAULT_TOKEN=$(vault write -field=token auth/${VAULT_AUTH_PATH}/login \
        role_id="${VAULT_ROLE_ID}" \
        secret_id="${VAULT_SECRET_ID}")
      
      if [ -z "$VAULT_TOKEN" ]; then
        echo "‚ùå Failed to authenticate with Vault"
        exit 1
      fi
      
      export VAULT_TOKEN
      echo "‚úÖ Vault authentication successful"
      
      # Recupera credenziali Kestra
      echo "üì• Fetching Kestra credentials..."
      KESTRA_USER=$(vault kv get -field=username kubernetes/apps/kestra)
      KESTRA_PASS=$(vault kv get -field=password kubernetes/apps/kestra)
      
      if [ -z "$KESTRA_USER" ] || [ -z "$KESTRA_PASS" ]; then
        echo "‚ùå Failed to retrieve Kestra credentials from Vault"
        exit 1
      fi
      
      export KESTRA_USER
      export KESTRA_PASS
      echo "‚úÖ Kestra credentials retrieved"
      
      # Installa curl
      apk add --no-cache curl
  script:
    - cd ${KESTRA_DIR}
    - |
      echo "Deploying flows to Kestra..."
      FAILED=0
      SUCCESS=0
      
      for flow in _flows/**/*.yml; do
        if [ -f "$flow" ]; then
          echo ""
          echo "========================================="
          echo "üì¶ Deploying: $flow"
          echo "========================================="
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -u "${KESTRA_USER}:${KESTRA_PASS}" \
            -H "Content-Type: application/x-yaml" \
            --data-binary @"$flow" \
            "${KESTRA_URL}/api/v1/flows/import")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "‚úÖ Successfully deployed: $flow"
            SUCCESS=$((SUCCESS + 1))
          else
            echo "‚ùå Failed to deploy: $flow"
            echo "HTTP Status: $http_code"
            echo "Response: $body"
            FAILED=$((FAILED + 1))
          fi
        fi
      done
      
      echo ""
      echo "========================================="
      echo "Deployment Summary"
      echo "========================================="
      echo "‚úÖ Success: $SUCCESS"
      echo "‚ùå Failed: $FAILED"
      echo "========================================="
      
      if [ $FAILED -gt 0 ]; then
        echo ""
        echo "‚ùå Some flows failed to deploy!"
        exit 1
      fi
      
      echo ""
      echo "‚úÖ All flows deployed successfully!"
  only:
    refs:
      - main
    changes:
      - kestra-flows/_flows/**/*.yml
  environment:
    name: production
    url: https://kestra.local.ildoc.it
