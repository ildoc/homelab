invidious:
  image:
    repository: quay.io/invidious/invidious
    tag: "2025.09.24-42d34cd"
    pullPolicy: IfNotPresent

  replicaCount: 1

  service:
    type: ClusterIP
    port: 3000

  ingress:
    enabled: false

  gateway:
    enabled: true
    gatewayName: "traefik-gateway"
    gatewayNamespace: "traefik"
    hostnames:
      - "invidious2.local.ildoc.it"
    rules:
      - matches:
          - path:
              type: PathPrefix
              value: "/"

  resources:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 500m
      memory: 512Mi

  podAnnotations:
    logging.options.max-size: "1G"
    logging.options.max-file: "4"

  podSecurityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

  # PostgreSQL Configuration - CORRETTA
  postgresql:
    enabled: false
    
    # Configurazione primary (struttura corretta per Bitnami v16.x)
    primary:
      persistence:
        enabled: true
        size: 10Gi
        storageClass: nfs-csi
      
      # Risorse per PostgreSQL
      resources:
        limits:
          cpu: 1000m
          memory: 1Gi
        requests:
          cpu: 250m
          memory: 256Mi
      
      # Configurazione PostgreSQL ottimizzata
      extendedConfiguration: |
        shared_buffers = 128MB
        effective_cache_size = 256MB
        max_connections = 50
        work_mem = 4MB

  # Companion configuration
  companion:
    enabled: true
    image:
      repository: quay.io/invidious/invidious-companion
      tag: "master-a866b71"
      pullPolicy: IfNotPresent
    
    service:
      port: 8282
    
    resources:
      limits:
        cpu: 2000m
        memory: 4Gi
      requests:
        cpu: 100m
        memory: 128Mi
    
    securityContext:
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      capabilities:
        drop:
          - ALL
    
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      seccompProfile:
        type: RuntimeDefault
    
    persistence:
      enabled: true
      size: 1Gi
      accessMode: ReadWriteOnce
      storageClass: nfs-csi

  # Configurazione Invidious
  config:
    db:
      user: invidious_user
      password: ""  # Verr√† preso da existingSecret
      host: "192.168.0.30"
      port: 5432
      dbname: invidious_db
    
    check_tables: true
    port: 3000
    domain: "invidious2.local.ildoc.it"
    https_only: true
    channel_threads: 1
    full_refresh: false
    feed_threads: 1
    
    invidious_companion:
      - private_url: ""  # Auto-popolato
    
    # Questi verranno presi da existingSecret
    invidious_companion_key: ""
    hmac_key: ""

  # Riferimento al secret creato dall'ExternalSecret
  existingSecret: "invidious-secrets"

  healthcheck:
    enabled: true
    command: ["/bin/sh", "-c", "wget -nv --tries=1 --spider http://127.0.0.1:3000/api/v1/trending || exit 1"]
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 2
