---
# Secret per database credentials (PostgreSQL esterno)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: kestra-db-secret
  namespace: apps
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-cross-secret-store
    kind: ClusterSecretStore
  target:
    name: kestra-db-secret
    creationPolicy: Owner
  data:
    - secretKey: postgres_password
      remoteRef:
        key: cross/data/apps/kestra
        property: postgres_password

---
# Secret per credenziali admin Kestra (basic auth)
# Questo secret viene montato come file di configurazione YAML
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: kestra-basic-auth
  namespace: apps
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-kubernetes-secret-store
    kind: ClusterSecretStore
  target:
    name: kestra-basic-auth
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        basic-auth.yml: |
          kestra:
            security:
              basic-auth:
                enabled: true
                username: "{{ .username }}"
                password: "{{ .password }}"
  data:
    - secretKey: username
      remoteRef:
        key: kubernetes/data/apps/kestra
        property: username
    
    - secretKey: password
      remoteRef:
        key: kubernetes/data/apps/kestra
        property: password

---
# Secret per workflow (accessibili tramite secret() function nei flow)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: kestra-workflow-secrets
  namespace: apps
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-kubernetes-secret-store
    kind: ClusterSecretStore
  target:
    name: kestra-workflow-secrets
    creationPolicy: Owner
  data:
    - secretKey: VAULT_ROLE_ID
      remoteRef:
        key: kubernetes/data/apps/kestra
        property: vault_role_id
    
    - secretKey: VAULT_SECRET_ID
      remoteRef:
        key: kubernetes/data/apps/kestra
        property: vault_secret_id
    
    - secretKey: GITLAB_TOKEN
      remoteRef:
        key: kubernetes/data/apps/kestra
        property: gitlab_token
