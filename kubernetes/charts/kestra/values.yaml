kestra:
  # Common settings applicati a tutti i deployment
  common:
    resources:
      limits:
        cpu: 2000m
        memory: 4Gi
      requests:
        cpu: 500m
        memory: 2Gi
    
    extraEnv:
      - name: TZ
        value: "Europe/Rome"
      # Credenziali DB come env vars
      - name: KESTRA_DATASOURCES_POSTGRES_USERNAME
        valueFrom:
          secretKeyRef:
            name: kestra-db-secret
            key: username
      - name: KESTRA_DATASOURCES_POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            name: kestra-db-secret
            key: password
    
    # Carica secrets per i workflow (accessibili con secret() function)
    extraEnvFrom:
      - secretRef:
          name: kestra-secrets
          prefix: SECRET_
    
    # Monta il PVC per storage persistente
    extraVolumes:
      - name: storage
        persistentVolumeClaim:
          claimName: kestra-storage
    
    extraVolumeMounts:
      - name: storage
        mountPath: /app/storage

  # Configurazione Kestra completa (con riferimenti a env vars per credenziali)
  configurations:
    application:
      kestra:
        server:
          base-url: "https://kestra.local.ildoc.it"
        
        repository:
          type: postgres
        
        queue:
          type: postgres
        
        storage:
          type: local
          local:
            base-path: "/app/storage"
      
      # Configurazione datasource COMPLETA (username/password da env vars)
      datasources:
        postgres:
          url: jdbc:postgresql://192.168.0.30:5432/kestra_db
          driver-class-name: org.postgresql.Driver
          dialect: POSTGRES
          username: ${KESTRA_DATASOURCES_POSTGRES_USERNAME}
          password: ${KESTRA_DATASOURCES_POSTGRES_PASSWORD}

  # Deployments
  deployments:
    standalone:
      enabled: true
    
    # Disabilita deployment separati
    webserver:
      enabled: false
    executor:
      enabled: false
    indexer:
      enabled: false
    scheduler:
      enabled: false
    worker:
      enabled: false

  # Service Account
  serviceAccount:
    create: true
    automount: false

  # Service (usa i default del chart)
  service:
    type: ClusterIP

  # Docker-in-Docker
  dind:
    enabled: true
    mode: rootless
    
    resources:
      limits:
        cpu: 1000m
        memory: 2Gi
      requests:
        cpu: 100m
        memory: 512Mi

  # Ingress disabilitato (usiamo HTTPRoute)
  ingress:
    enabled: false
