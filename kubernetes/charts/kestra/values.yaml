---
kestra:
  # Configurazioni comuni
  common:
    kind: Deployment
    replicas: 1

    # Resources
    resources:
      limits:
        cpu: 2000m
        memory: 4Gi
      requests:
        cpu: 500m
        memory: 2Gi
    
    nodeSelector: {}
    tolerations: []
    affinity: {}
    
    # Environment variables da secrets per i workflow
    extraEnvFrom:
      - secretRef:
          name: kestra-workflow-secrets
    
    # Environment variables per database PostgreSQL
    extraEnv:
      - name: TZ
        value: "Europe/Rome"
      
      # Configurazione datasource PostgreSQL
      - name: DATASOURCES_POSTGRES_URL
        value: "jdbc:postgresql://192.168.0.30:5432/kestra_db"
      - name: DATASOURCES_POSTGRES_USERNAME
        value: "kestra_user"
      - name: DATASOURCES_POSTGRES_PASSWORD
        valueFrom:
          secretKeyRef:
            name: kestra-db-secret
            key: postgres_password
      - name: DATASOURCES_POSTGRES_DRIVER_CLASS_NAME
        value: "org.postgresql.Driver"
    
    # Monta il secret basic-auth come file di configurazione
    extraVolumes:
      - name: basic-auth-config
        secret:
          secretName: kestra-basic-auth
      - name: storage
        persistentVolumeClaim:
          claimName: kestra-storage
    
    extraVolumeMounts:
      - name: basic-auth-config
        mountPath: /app/confs/basic-auth.yml
        subPath: basic-auth.yml
        readOnly: true
      - name: storage
        mountPath: /app/storage

  # Configurazione Kestra - questa Ã¨ la configurazione principale!
  configurations:
    application:
      datasources:
        postgres:
          url: jdbc:postgresql://192.168.0.30:5432/kestra_db
          username: kestra_user
          password: ${DATASOURCES_POSTGRES_PASSWORD}
          driver-class-name: org.postgresql.Driver
      
      kestra:
        server:
          base-url: "https://kestra.local.ildoc.it"
        
        # Repository usando PostgreSQL
        repository:
          type: postgres
        
        # Queue usando PostgreSQL  
        queue:
          type: postgres
        
        # Storage locale (montato da PVC)
        storage:
          type: local
          local:
            base-path: "/app/storage"
        
        # Configurazione tasks
        tasks:
          tmp-dir:
            path: "/tmp/kestra-wd/tmp"
        
        # URL pubblico
        url: "https://kestra.local.ildoc.it"
    
    # Monta il secret come file addizionale
    secrets:
      - name: kestra-basic-auth
        key: basic-auth.yml

  # Service Account
  serviceAccount:
    create: true
    automount: false

  # Deployment standalone
  deployments:
    standalone:
      enabled: true
      workerThreads: 0
    
    # Disabilita tutti gli altri
    webserver:
      enabled: false
    executor:
      enabled: false
    indexer:
      enabled: false
    scheduler:
      enabled: false
    worker:
      enabled: false

  # Service
  service:
    type: ClusterIP
    ports:
      http:
        port: 8080
        containerPort: 8080
        targetPort: http
        protocol: TCP
      management:
        port: 8081
        containerPort: 8081
        targetPort: management
        protocol: TCP

  # Docker-in-Docker
  dind:
    enabled: true
    mode: 'rootless'
    
    base:
      rootless:
        image:
          repository: docker
          pullPolicy: IfNotPresent
          tag: dind-rootless@sha256:82202f05939bf78cd34db8fcc3e9a0f8dcd43810cf2d29b8f0e53029746509fd
        securityContext:
          privileged: true
          runAsUser: 1000
          runAsGroup: 1000
        args:
          - --log-level=fatal
          - --group=1000
        resources:
          limits:
            cpu: 1000m
            memory: 2Gi
          requests:
            cpu: 100m
            memory: 512Mi

  # Ingress disabilitato
  ingress:
    enabled: false
