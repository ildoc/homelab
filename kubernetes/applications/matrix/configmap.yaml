---
apiVersion: v1
kind: ConfigMap
metadata:
  name: matrix-config
  namespace: apps
  annotations:
    argocd.argoproj.io/sync-wave: "1"
data:
  homeserver.yaml: |
    server_name: "matrix.ildoc.it"
    public_baseurl: "https://matrix.ildoc.it"
    
    listeners:
      - port: 8008
        tls: false
        type: http
        x_forwarded: true
        bind_addresses: ['0.0.0.0']
        resources:
          - names: [client, federation]
            compress: false

    # Database - valori hardcoded tranne la password
    database:
      name: psycopg2
      args:
        user: matrix_user
        password: ${POSTGRES_PASSWORD}
        database: matrix_db
        host: 192.168.0.30
        port: 5432
        cp_min: 5
        cp_max: 10

    # Redis - valori hardcoded tranne la password
    redis:
      enabled: true
      host: matrix-redis.apps.svc.cluster.local
      port: 6379
      password: ${SYNAPSE_REDIS_PASSWORD}

    log_config: "/data/log.config"
    media_store_path: "/data/media_store"
    max_upload_size: "50M"
    max_image_pixels: "32M"
    url_preview_enabled: false

    # =========================================================================
    # ðŸ†• CONFIGURAZIONE OIDC CON AUTHENTIK
    # =========================================================================
    
    # Disabilita registrazione diretta (gli utenti arrivano via OIDC)
    enable_registration: false
    enable_registration_without_verification: false
    registration_requires_token: false

    password_config:
      enabled: false
      localdb_enabled: true
      pepper: ""
      policy:
        enabled: false
    
    # Configurazione OIDC
    oidc_providers:
      - idp_id: oidc-authentik
        idp_name: "Authentik"
        idp_icon: "mxc://matrix.ildoc.it/authentik-icon"  # Opzionale
        discover: true
        issuer: "https://auth.ildoc.it/application/o/matrix-synapse/"
        client_id: "matrix-synapse"
        client_secret: ${OIDC_CLIENT_SECRET}
        scopes: ["openid", "profile", "email"]
        
        enable_device_authorization: true

        # Mapping attributi da Authentik a Matrix
        user_mapping_provider:
          config:
            # Campo che contiene lo username (parte prima di :matrix.ildoc.it)
            localpart_template: "{{ user.preferred_username }}"
            
            # Display name dell'utente
            display_name_template: "{{ user.name|default(user.preferred_username) }}"
            
            # Email dell'utente
            email_template: "{{ user.email }}"
            
            # Subject claim (identificatore univoco)
            subject_claim: "sub"
        
        # Comportamento autenticazione
        allow_existing_users: true  # Permetti a utenti esistenti di linkare OIDC
        
        # User attributes (opzionale, per attributi custom)
        # user_profile_method: "userinfo_endpoint"
    
    # Usa env vars per i secret
    registration_shared_secret: ${REGISTRATION_SHARED_SECRET}
    macaroon_secret_key: ${MACAROON_SECRET_KEY}
    form_secret: ${FORM_SECRET}
    
    enable_3pid_lookup: false
    allow_public_rooms_without_auth: false
    allow_public_rooms_over_federation: false
    
    rc_message:
      per_second: 0.2
      burst_count: 10
    
    rc_registration:
      per_second: 0.17
      burst_count: 3
    
    rc_login:
      address:
        per_second: 0.17
        burst_count: 3
      account:
        per_second: 0.17
        burst_count: 3
      failed_attempts:
        per_second: 0.17
        burst_count: 3
    
    # federation_domain_whitelist: []
    signing_key_path: "/data/keys/signing.key"
    
    trusted_key_servers:
      - server_name: "matrix.org"
    
    report_stats: false
    enable_metrics: true
    metrics_port: 9000

    retention:
      enabled: true
      default_policy:
        min_lifetime: 1d
        max_lifetime: 365d
      
      # Consenti agli admin di sovrascrivere
      allow_lifetime_updates: true
      
      # Policy specifiche per tipo di stanza
      policies:
        - min_lifetime: 7d
          max_lifetime: 365d
      
      purge_jobs:
        - interval: 24h
          threshold: 365d
      
    federation:
      backfill_on_join: false


  log.config: |
    version: 1
    
    formatters:
      precise:
        format: '%(asctime)s - %(name)s - %(lineno)d - %(levelname)s - %(request)s - %(message)s'
    
    handlers:
      console:
        class: logging.StreamHandler
        formatter: precise
        stream: ext://sys.stdout
    
    loggers:
        synapse.storage.SQL:
            level: INFO
        synapse.handlers.oidc:
            level: INFO
    
    root:
      level: INFO
      handlers: [console]
    
    disable_existing_loggers: false
