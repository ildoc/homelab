---
apiVersion: v1
kind: ConfigMap
metadata:
  name: matrix-config
  namespace: apps
  annotations:
    argocd.argoproj.io/sync-wave: "1"
data:
  homeserver.yaml: |
    server_name: "matrix.ildoc.it"
    public_baseurl: "https://matrix.ildoc.it"
    
    listeners:
      - port: 8008
        tls: false
        type: http
        x_forwarded: true
        bind_addresses: ['0.0.0.0']
        resources:
          - names: [client, federation]
            compress: false

    # Database - usa env vars
    database:
      name: psycopg2
      args:
        user: ${POSTGRES_USER}
        password: ${POSTGRES_PASSWORD}
        database: ${POSTGRES_DB}
        host: ${POSTGRES_HOST}
        port: ${POSTGRES_PORT}
        cp_min: 5
        cp_max: 10

    # Redis - usa env vars con username
    redis:
      enabled: true
      host: ${SYNAPSE_REDIS_HOST}
      port: ${SYNAPSE_REDIS_PORT}
      password: ${SYNAPSE_REDIS_PASSWORD}

    log_config: "/data/log.config"
    media_store_path: "/data/media_store"
    max_upload_size: "50M"
    max_image_pixels: "32M"
    url_preview_enabled: false
    
    enable_registration: false
    enable_registration_without_verification: false
    registration_requires_token: false
    
    # Usa env vars per i secret
    registration_shared_secret: ${REGISTRATION_SHARED_SECRET}
    macaroon_secret_key: ${MACAROON_SECRET_KEY}
    form_secret: ${FORM_SECRET}
    
    enable_3pid_lookup: false
    allow_public_rooms_without_auth: false
    allow_public_rooms_over_federation: false
    
    rc_message:
      per_second: 0.2
      burst_count: 10
    
    rc_registration:
      per_second: 0.17
      burst_count: 3
    
    rc_login:
      address:
        per_second: 0.17
        burst_count: 3
      account:
        per_second: 0.17
        burst_count: 3
      failed_attempts:
        per_second: 0.17
        burst_count: 3
    
    federation_domain_whitelist: []
    signing_key_path: "/data/keys/signing.key"
    
    trusted_key_servers:
      - server_name: "matrix.org"
    
    report_stats: false
    enable_metrics: true
    metrics_port: 9000

  log.config: |
    version: 1
    
    formatters:
      precise:
        format: '%(asctime)s - %(name)s - %(lineno)d - %(levelname)s - %(request)s - %(message)s'
    
    handlers:
      console:
        class: logging.StreamHandler
        formatter: precise
        stream: ext://sys.stdout
    
    loggers:
        synapse.storage.SQL:
            level: INFO
    
    root:
      level: INFO
      handlers: [console]
    
    disable_existing_loggers: false
