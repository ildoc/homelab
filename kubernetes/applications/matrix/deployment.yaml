---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: matrix-synapse
  namespace: apps
spec:
  selector:
    matchLabels:
      app: matrix-synapse
  strategy:
    type: Recreate
  revisionHistoryLimit: 3
  template:
    metadata:
      labels:
        app: matrix-synapse
    spec:
      containers:
        - name: synapse
          image: ghcr.io/element-hq/synapse:v1.123.0
          env:
            - name: SYNAPSE_SERVER_NAME
              value: "matrix.ildoc.it"
            - name: SYNAPSE_REPORT_STATS
              value: "no"
            - name: UID
              value: "991"
            - name: GID
              value: "991"
            - name: TZ
              value: "Europe/Rome"
            
            # PostgreSQL configuration (da cross-secrets)
            - name: POSTGRES_HOST
              value: "192.168.0.40"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DB
              value: "matrix_db"
            - name: POSTGRES_USER
              value: "matrix_user"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-cross-secrets  # DA CROSS
                  key: postgres-password
            
            - name: SYNAPSE_REDIS_HOST
              value: "matrix-redis.apps.svc.cluster.local"  # Service interno
            - name: SYNAPSE_REDIS_PORT
              value: "6379"
            - name: SYNAPSE_REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-redis-secret
                  key: password
            
            # Synapse secrets (da k8s-secrets)
            - name: REGISTRATION_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: matrix-k8s-secrets  # DA KUBERNETES
                  key: registration-shared-secret
            - name: MACAROON_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: matrix-k8s-secrets  # DA KUBERNETES
                  key: macaroon-secret-key
            - name: FORM_SECRET
              valueFrom:
                secretKeyRef:
                  name: matrix-k8s-secrets  # DA KUBERNETES
                  key: form-secret
          
          ports:
            - containerPort: 8008
              name: http
              protocol: TCP
            - containerPort: 8448
              name: federation
              protocol: TCP
          
          volumeMounts:
            - name: data
              mountPath: /data
            - name: config
              mountPath: /data/homeserver.yaml
              subPath: homeserver.yaml
            - name: config
              mountPath: /data/log.config
              subPath: log.config
          
          resources:
            limits:
              cpu: 2000m
              memory: 4Gi
            requests:
              cpu: 500m
              memory: 1Gi
          
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: matrix-synapse
        - name: config
          configMap:
            name: matrix-config
