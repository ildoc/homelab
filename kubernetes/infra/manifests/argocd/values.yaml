argo-cd:
  global:
    domain: argocd.local.ildoc.it

  redis-ha:
    enabled: true
    haproxy:
      enabled: true

  controller:
    replicas: 1

  server:
    replicas: 2
    ingress:
      enabled: false
    httpRoute:
      enabled: true
      parentRefs:
        - name: cilium-gateway
          namespace: kube-system
          sectionName: https
      hostnames:
        - argocd.local.ildoc.it

  repoServer:
    replicas: 2

  applicationSet:
    replicas: 2

  configs:
    cm:
      timeout.reconciliation: 180s
      
      # URL base di ArgoCD
      url: https://argocd.local.ildoc.it
      
      # Configurazione DEX per Authentik (permette uso CLI)
      dex.config: |
        connectors:
        - config:
            issuer: https://auth.ildoc.it/application/o/argocd/
            clientID: QJvMPH0bco4sp7NvqtvfWJLUZQJaVYDHt0Dtow4Z
            clientSecret: $argocd-dex-secrets:dex.authentik.clientSecret
            insecureEnableGroups: true
            getUserInfo: true
            scopes:
              - openid
              - profile
              - email
              - groups
          name: authentik
          type: oidc
          id: authentik
      
      # Health check per le EndpointSlices
      resource.customizations.health.discovery.k8s.io_EndpointSlice: |
        hs = {}
        hs.status = "Healthy"
        hs.message = "EndpointSlice is present"
        return hs
    
    params:
      server.insecure: "true"
      application.resourceTrackingMethod: "annotation"
    
    # RBAC policy per mappare i gruppi di Authentik
    rbac:
      policy.csv: |
        # Mappatura gruppi Authentik -> Ruoli ArgoCD
        g, argocd-admins, role:admin
        g, argocd-readonly, role:readonly
    
    # ArgoCD non deve gestire secret locali per DEX:
    # il clientSecret arriva da ExternalSecret dedicato.
    secret:
      createSecret: false
    
    # Inclusione ristretta solo al namespace external-routes
    resource.inclusions: |
      - apiGroups:
        - discovery.k8s.io
        kinds:
        - EndpointSlice
        clusters:
        - '*'
        namespaces:
        - external-routes
