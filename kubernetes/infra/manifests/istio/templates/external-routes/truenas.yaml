{{- if .Values.externalServices.truenas.enabled }}
---
# ServiceEntry per TrueNAS
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: truenas-external
  namespace: {{ .Values.gateway.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  hosts:
  - truenas-external.{{ .Values.gateway.namespace }}.svc.cluster.local
  
  location: MESH_EXTERNAL
  
  ports:
  - number: {{ (index .Values.externalServices.truenas.backend.endpoints 0).port }}
    name: https
    protocol: HTTPS
  
  resolution: STATIC
  
  endpoints:
  {{- range .Values.externalServices.truenas.backend.endpoints }}
  - address: {{ .address }}
    ports:
      https: {{ .port }}
  {{- end }}

---
# DestinationRule per TLS config
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: truenas-external
  namespace: {{ .Values.gateway.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  host: truenas-external.{{ .Values.gateway.namespace }}.svc.cluster.local
  
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    
    tls:
      mode: SIMPLE
      {{- if .Values.externalServices.truenas.backend.skipVerify }}
      insecureSkipVerify: true
      {{- end }}
    
    connectionPool:
      http:
        http1MaxPendingRequests: 512
        maxRequestsPerConnection: 10

---
# HTTPRoute per routing
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: truenas-external
  namespace: {{ .Values.gateway.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  parentRefs:
  - name: {{ .Values.gateway.name }}
    namespace: {{ .Values.gateway.namespace }}
  
  hostnames:
  - {{ .Values.externalServices.truenas.hostname | quote }}
  
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    
    backendRefs:
    - name: truenas-external
      namespace: {{ .Values.gateway.namespace }}
      port: {{ (index .Values.externalServices.truenas.backend.endpoints 0).port }}
      group: ""
      kind: Service
{{- end }}
