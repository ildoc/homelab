{{- if .Values.gateway.enabled }}
---
# Gateway Deployment (managed by Istio)
apiVersion: v1
kind: Service
metadata:
  name: {{ .Values.gateway.name }}
  namespace: {{ .Values.gateway.namespace }}
  labels:
    app: {{ .Values.gateway.name }}
    istio: external-gateway
  annotations:
    {{- toYaml .Values.gateway.serviceAnnotations | nindent 4 }}
spec:
  type: {{ .Values.gateway.serviceType }}
  {{- if .Values.gateway.loadBalancerIP }}
  loadBalancerIP: {{ .Values.gateway.loadBalancerIP }}
  {{- end }}
  selector:
    app: {{ .Values.gateway.name }}
    istio: external-gateway
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 8080
  - name: https
    port: 443
    protocol: TCP
    targetPort: 8443
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.gateway.name }}
  namespace: {{ .Values.gateway.namespace }}
  labels:
    app: {{ .Values.gateway.name }}
    istio: external-gateway
spec:
  replicas: 2
  selector:
    matchLabels:
      app: {{ .Values.gateway.name }}
      istio: external-gateway
  template:
    metadata:
      annotations:
        inject.istio.io/templates: gateway
      labels:
        app: {{ .Values.gateway.name }}
        istio: external-gateway
        sidecar.istio.io/inject: "true"
    spec:
      serviceAccountName: {{ .Values.gateway.name }}
      securityContext:
        sysctls:
        - name: net.ipv4.ip_unprivileged_port_start
          value: "0"
      containers:
      - name: istio-proxy
        image: auto
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.gateway.name }}
  namespace: {{ .Values.gateway.namespace }}
---
# ReferenceGrant per accedere al certificato TLS
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-istio-gateway-cert
  namespace: {{ .Values.gateway.tls.secretNamespace }}
spec:
  from:
  - group: gateway.networking.k8s.io
    kind: Gateway
    namespace: {{ .Values.gateway.namespace }}
  to:
  - group: ""
    kind: Secret
    name: {{ .Values.gateway.tls.secretName }}
---
# Istio Gateway resource (usa API Istio nativa, non K8s Gateway API)
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: {{ .Values.gateway.name }}
  namespace: {{ .Values.gateway.namespace }}
spec:
  selector:
    app: {{ .Values.gateway.name }}
    istio: external-gateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*.local.ildoc.it"
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "*.local.ildoc.it"
    tls:
      mode: SIMPLE
      credentialName: {{ .Values.gateway.tls.secretName }}
{{- end }}
