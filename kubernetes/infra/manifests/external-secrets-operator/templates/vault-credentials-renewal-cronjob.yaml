apiVersion: batch/v1
kind: CronJob
metadata:
  name: vault-credentials-renewal
  namespace: {{ .Release.Namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "4"
spec:
  schedule: "0 0 1,15 * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ index .Values "external-secrets" "serviceAccount" "name" }}
          containers:
            - name: vault-renew
              image: alpine/k8s:1.31.7
              command: ["/bin/sh", "-c"]
              args:
                - |
                  set -euo pipefail
                  
                  echo "[INFO] Starting Vault authentication renewal..."
                  
                  VAULT_ROLE_NAME="{{ .Values.vault.roleName }}"
                  VAULT_ADDRESS="{{ .Values.vault.address }}"
                  
                  # Ottieni il token JWT dal service account
                  JWT_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
                  
                  # Autentica con Vault
                  echo "[INFO] Authenticating with Vault..."
                  AUTH_RESULT=$(curl -s --request POST \
                    --data "{\"jwt\": \"$JWT_TOKEN\", \"role\": \"$VAULT_ROLE_NAME\"}" \
                    $VAULT_ADDRESS/v1/auth/kubernetes/login)
                  
                  # Log
                  echo "[DEBUG] Auth result: $AUTH_RESULT"
                  
                  # Estrai il token
                  CLIENT_TOKEN=$(echo $AUTH_RESULT | grep -o '"client_token":"[^"]*' | sed 's/"client_token":"//g')
                  
                  if [ -z "$CLIENT_TOKEN" ]; then
                    echo "[ERROR] Failed to authenticate with Vault"
                    exit 1
                  fi
                  
                  echo "[INFO] Successfully authenticated. Token obtained."
                  
                  # Il test di autenticazione è riuscito, non serve fare altro
                  # External Secrets utilizzerà il meccanismo di autenticazione JWT
                  
                  echo "[INFO] Vault authentication renewal completed."
          restartPolicy: OnFailure
