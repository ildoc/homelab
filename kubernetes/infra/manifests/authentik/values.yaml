---
# =============================================================================
# AUTHENTIK CORE CONFIGURATION
# =============================================================================
authentik:
  # RIMOSSO: Non specificare secret_key qui, viene caricato tramite env var
  
  # Log level
  log_level: info
  
  # Avatars
  avatars: gravatar,initials
  
  # Error reporting - disabilitato
  error_reporting:
    enabled: false
  
  # IMPORTANTE: Queste sezioni sono necessarie anche se usi environment variables
  # Il chart le usa per alcune validazioni interne
  postgresql:
    host: "192.168.0.30"
    port: 5432
    name: "authentik_db"
    user: "authentik_user"
  
  redis:
    host: "192.168.0.40"
    port: 6379
  
  # Email configuration (opzionale)
  email:
    host: ""
    port: 587
    username: ""
    password: ""
    use_tls: false
    use_ssl: false
    timeout: 30
    from: "authentik@ildoc.it"

# =============================================================================
# GLOBAL CONFIGURATION - APPLICA A SERVER E WORKER
# =============================================================================
global:
  # Storage class per PVC (se necessario)
  storageClass: nfs-csi
  
  # Deployment strategy comune
  deploymentStrategy:
    type: RollingUpdate

  # CRITICO: Environment variables che si applicano a TUTTI i pod
  env:
    # PostgreSQL - configurazione completa
    - name: AUTHENTIK_POSTGRESQL__HOST
      value: "192.168.0.30"
    - name: AUTHENTIK_POSTGRESQL__NAME
      value: "authentik_db"
    - name: AUTHENTIK_POSTGRESQL__USER
      value: "authentik_user"
    - name: AUTHENTIK_POSTGRESQL__PORT
      value: "5432"
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-postgresql-secret
          key: postgres-password
    
    # Redis - configurazione completa con username e DB dedicato
    - name: AUTHENTIK_REDIS__HOST
      value: "192.168.0.40"
    - name: AUTHENTIK_REDIS__PORT
      value: "6379"
    - name: AUTHENTIK_REDIS__DB
      value: "1"
    - name: AUTHENTIK_REDIS__USERNAME
      value: "authentik"
    - name: AUTHENTIK_REDIS__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-redis-secret
          key: redis-password
    
    # Redis per Celery message queue (usa stesso DB per coerenza)
    - name: AUTHENTIK_REDIS__CACHE_DB
      value: "1"
    - name: AUTHENTIK_REDIS__MESSAGE_QUEUE_DB
      value: "1"
    - name: AUTHENTIK_REDIS__WS_DB
      value: "1"
    
    # Secret key - OBBLIGATORIO
    - name: AUTHENTIK_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: authentik-secret
          key: secret-key
    
    # Host configuration - NOTA IL TRAILING SLASH
    - name: AUTHENTIK_HOST
      value: "https://auth.ildoc.it/"
    
    # Browser host (se diverso da AUTHENTIK_HOST)
    - name: AUTHENTIK_HOST_BROWSER
      value: "https://auth.ildoc.it/"

    # Trusted proxies per Cloudflare
    - name: AUTHENTIK_LISTEN__TRUSTED_PROXY_IP
      value: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

    - name: AUTHENTIK_WEB__WORKERS
      value: "2"

# =============================================================================
# SERVER DEPLOYMENT
# =============================================================================
server:
  # Nome del deployment
  name: server
  
  # Numero di repliche
  replicas: 2
  
  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi
  
  # Anti-affinity per distribuire i pod su nodi diversi
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authentik
                app.kubernetes.io/component: server
            topologyKey: kubernetes.io/hostname
  
  # Probes - aumentati i timeout per startup lento con DB esterno
  livenessProbe:
    httpGet:
      path: /-/health/live/
      port: http
    initialDelaySeconds: 50
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /-/health/ready/
      port: http
    initialDelaySeconds: 50
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  startupProbe:
    httpGet:
      path: /-/health/live/
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 60
  
  # Service configuration
  service:
    type: ClusterIP
    port: 80
    name: http
    protocol: TCP
    annotations: {}
  
  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false
  
  # Ingress - DISABILITATO (usiamo HTTPRoute custom)
  ingress:
    enabled: false
  
  # PDB
  pdb:
    enabled: true
    minAvailable: 1

# =============================================================================
# WORKER DEPLOYMENT
# =============================================================================
worker:
  # Nome del deployment
  name: worker
  
  # Numero di repliche
  replicas: 2
  
  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  
  # Anti-affinity
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authentik
                app.kubernetes.io/component: worker
            topologyKey: kubernetes.io/hostname
  
  # PDB
  pdb:
    enabled: true
    minAvailable: 1
  
  # Metrics (supporto in 2025.8.x)
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false

# =============================================================================
# POSTGRESQL SUBCHART - DISABILITATO (usi PostgreSQL esterno)
# =============================================================================
postgresql:
  enabled: false

# =============================================================================
# REDIS SUBCHART - DISABILITATO (usi Redis esterno)
# =============================================================================
redis:
  enabled: false

# =============================================================================
# SERVICE ACCOUNT - NECESSARIO PER MANAGED OUTPOSTS
# =============================================================================
serviceAccount:
  # CRITICO: Abilita questo per permettere la creazione di outpost managed
  create: true
  annotations: {}
  
  # Disabilita il secret del service account (non necessario per outpost esterni)
  serviceAccountSecret:
    enabled: false

# =============================================================================
# GEOIP - OPZIONALE
# =============================================================================
geoip:
  enabled: false
  editionIds: "GeoLite2-City GeoLite2-ASN"
  updateInterval: 8
  accountId: ""
  licenseKey: ""

# =============================================================================
# CONFIGURAZIONI CUSTOM PER IL WRAPPER CHART
# =============================================================================

# Hostname per HTTPRoute custom
ingress:
  hostname: auth.ildoc.it

# SMTP (se necessario in futuro)
smtp:
  enabled: false

# Outpost per forward auth (proxy provider)
outpost:
  replicas: 2
  image:
    tag: "2025.8.4"
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authentik-proxy-outpost
            topologyKey: kubernetes.io/hostname
