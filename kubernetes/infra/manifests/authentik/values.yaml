---
# =============================================================================
# AUTHENTIK CORE CONFIGURATION
# =============================================================================
authentik:
  # Secret key - DEVE essere iniettato tramite env var
  # Lasciare vuoto perché verrà fornito da AUTHENTIK_SECRET_KEY
  secret_key: ""
  
  # Log level
  log_level: info
  
  # Avatars
  avatars: gravatar,initials
  
  # Error reporting - disabilitato
  error_reporting:
    enabled: false
  
  # PostgreSQL ESTERNO - configurazione connessione
  postgresql:
    host: "192.168.0.30"
    port: 5432
    name: "authentik_db"
    user: "authentik_user"
    # password NON va specificata qui - verrà iniettata tramite env var
  
  # Redis ESTERNO - configurazione connessione
  redis:
    host: "192.168.0.40"
    port: 6379
    # password NON va specificata qui - verrà iniettata tramite env var
  
  # Email configuration (opzionale)
  email:
    host: ""
    port: 587
    username: ""
    password: ""
    use_tls: false
    use_ssl: false
    timeout: 30
    from: "authentik@local.ildoc.it"

# =============================================================================
# GLOBAL CONFIGURATION
# =============================================================================
global:
  # Storage class per PVC (se necessario)
  storageClass: nfs-csi
  
  # Deployment strategy comune
  deploymentStrategy:
    type: RollingUpdate

# =============================================================================
# SERVER DEPLOYMENT
# =============================================================================
server:
  # Nome del deployment
  name: server
  
  # Numero di repliche
  replicas: 2
  
  # IMPORTANTE: Iniezione secrets tramite variabili d'ambiente
  # Questo è l'approccio raccomandato per usare existing secrets
  env:
    # Secret key principale di Authentik
    - name: AUTHENTIK_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: authentik-secret
          key: AUTHENTIK_SECRET_KEY
    
    # Password PostgreSQL
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-postgresql-secret
          key: AUTHENTIK_POSTGRESQL__PASSWORD
    
    # Password Redis
    - name: AUTHENTIK_REDIS__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-redis-secret
          key: AUTHENTIK_REDIS__PASSWORD
  
  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi
  
  # Anti-affinity per distribuire i pod su nodi diversi
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authentik
                app.kubernetes.io/component: server
            topologyKey: kubernetes.io/hostname
  
  # Probes
  livenessProbe:
    httpGet:
      path: /-/health/live/
      port: http
    initialDelaySeconds: 50
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    httpGet:
      path: /-/health/ready/
      port: http
    initialDelaySeconds: 50
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  startupProbe:
    httpGet:
      path: /-/health/live/
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 60
  
  # Service configuration
  service:
    type: ClusterIP
    port: 80
    name: http
    protocol: TCP
    annotations: {}
  
  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false
  
  # Ingress - DISABILITATO (usiamo HTTPRoute custom)
  ingress:
    enabled: false
  
  # PDB
  pdb:
    enabled: true
    minAvailable: 1

# =============================================================================
# WORKER DEPLOYMENT
# =============================================================================
worker:
  # Nome del deployment
  name: worker
  
  # Numero di repliche
  replicas: 2
  
  # IMPORTANTE: Stesse variabili d'ambiente del server
  env:
    - name: AUTHENTIK_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: authentik-secret
          key: AUTHENTIK_SECRET_KEY
    
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-postgresql-secret
          key: AUTHENTIK_POSTGRESQL__PASSWORD
    
    - name: AUTHENTIK_REDIS__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-redis-secret
          key: AUTHENTIK_REDIS__PASSWORD
  
  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  
  # Anti-affinity
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authentik
                app.kubernetes.io/component: worker
            topologyKey: kubernetes.io/hostname
  
  # PDB
  pdb:
    enabled: true
    minAvailable: 1
  
  # Metrics (novità in 2025.8.x)
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false

# =============================================================================
# POSTGRESQL SUBCHART - DISABILITATO (usi PostgreSQL esterno)
# =============================================================================
postgresql:
  enabled: false

# =============================================================================
# REDIS SUBCHART - DISABILITATO (usi Redis esterno)
# =============================================================================
redis:
  enabled: false

# =============================================================================
# SERVICE ACCOUNT
# =============================================================================
serviceAccount:
  # Necessario per managed outposts
  create: true
  annotations: {}
  
  # Disabilita il secret del service account (non necessario)
  serviceAccountSecret:
    enabled: false

# =============================================================================
# GEOIP - OPZIONALE
# =============================================================================
geoip:
  enabled: false
  editionIds: "GeoLite2-City GeoLite2-ASN"
  updateInterval: 8
  accountId: ""
  licenseKey: ""

# =============================================================================
# CONFIGURAZIONI CUSTOM PER IL WRAPPER CHART
# =============================================================================

# Hostname per HTTPRoute custom
ingress:
  hostname: auth.local.ildoc.it

# SMTP (se necessario in futuro)
smtp:
  enabled: false

# Outpost per forward auth (proxy provider)
outpost:
  replicas: 2
  image:
    tag: "2025.8.4"
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: authentik-proxy-outpost
            topologyKey: kubernetes.io/hostname
