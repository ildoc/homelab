---
gitlab-runner:
  gitlabUrl: http://gitlab.local.ildoc.it/
  
  replicas: 2
  concurrent: 10
  checkInterval: 30
  logLevel: info
  
  # Usa il secret per il token
  runnerToken: ""
  
  # Il secret verr√† creato da External Secrets
  runners:
    secret: gitlab-runner-auth-secret
    
    config: |
      [[runners]]
        name = "kubernetes-runner-{{.index}}"
        executor = "kubernetes"
        output_limit = 16384
        request_concurrency = 3
        
        [runners.kubernetes]
          namespace = "{{.Release.Namespace}}"
          image = "alpine:3.19"
          pull_policy = ["if-not-present"]
          
          # IMPORTANTE: Necessario per overlay storage driver
          privileged = true
          
          # Risorse per il container principale del job
          cpu_limit = "2"
          cpu_request = "500m"
          memory_limit = "4Gi"
          memory_request = "512Mi"
          
          # Risorse per l'helper
          helper_cpu_limit = "500m"
          helper_cpu_request = "100m"
          helper_memory_limit = "256Mi"
          helper_memory_request = "128Mi"
          
          service_account = "gitlab-runner"
          poll_interval = 3
          poll_timeout = 180
          
          # Volume per storage temporaneo buildah/podman
          [[runners.kubernetes.volumes.empty_dir]]
            name = "buildah-storage"
            mount_path = "/var/lib/containers"
            medium = ""
            size_limit = "10Gi"
          
          # Cache volume per artifacts
          [[runners.kubernetes.volumes.pvc]]
            name = "gitlab-runner-cache"
            mount_path = "/cache"
            read_only = false
            mount_propagation = "HostToContainer"
  
  rbac:
    create: true
    clusterWideAccess: false
    serviceAccountName: gitlab-runner
    
  metrics:
    enabled: true
    port: 9252
    
  resources:
    limits:
      memory: 256Mi
      cpu: 200m
    requests:
      memory: 128Mi
      cpu: 100m
  
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app: gitlab-runner
            topologyKey: kubernetes.io/hostname
