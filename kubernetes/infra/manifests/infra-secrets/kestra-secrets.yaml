---
# Secret per database credentials (come chiavi separate, non come file YAML)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: kestra-db-secret
  namespace: apps
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-cross-secret-store
    kind: ClusterSecretStore
  target:
    name: kestra-db-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        username: kestra_user
        password: "{{ .postgres_password }}"
  data:
    - secretKey: postgres_password
      remoteRef:
        key: cross/data/apps/kestra
        property: postgres_password

---
# Secret per workflow (accessibili tramite secret() function)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: kestra-secrets
  namespace: apps
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-kubernetes-secret-store
    kind: ClusterSecretStore
  target:
    name: kestra-secrets
    creationPolicy: Owner
  data:
    - secretKey: VAULT_ROLE_ID
      remoteRef:
        key: kubernetes/data/apps/kestra
        property: vault_role_id
    
    - secretKey: VAULT_SECRET_ID
      remoteRef:
        key: kubernetes/data/apps/kestra
        property: vault_secret_id
    
    - secretKey: GITLAB_TOKEN
      remoteRef:
        key: kubernetes/data/apps/kestra
        property: gitlab_token
    
