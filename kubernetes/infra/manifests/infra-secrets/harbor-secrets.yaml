---
# Database credentials
# Harbor 1.18.0 richiede la chiave POSTGRESQL_PASSWORD
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: vault-harbor-database-secrets
  namespace: harbor
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-cluster-secret-store
    kind: ClusterSecretStore
  target:
    name: harbor-database-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        POSTGRESQL_PASSWORD: "{{ .password }}"
  data:
    - secretKey: password
      remoteRef:
        key: cross/data/apps/harbor
        property: db_password

---
# Redis credentials
# Harbor 1.18.0 richiede la chiave REDIS_PASSWORD
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: vault-harbor-redis-secrets
  namespace: harbor
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-cluster-secret-store
    kind: ClusterSecretStore
  target:
    name: harbor-redis-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        REDIS_PASSWORD: "{{ .password }}"
  data:
    - secretKey: password
      remoteRef:
        key: cross/data/apps/harbor
        property: redis_password

---
# Harbor Core secrets (admin password, secret key, etc.)
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: vault-harbor-core-secrets
  namespace: harbor
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-cluster-secret-store
    kind: ClusterSecretStore
  target:
    name: harbor-core-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        secret: "{{ .secret }}"
        HARBOR_ADMIN_PASSWORD: "{{ .admin_password }}"
  data:
    - secretKey: secret
      remoteRef:
        key: kubernetes/data/apps/harbor
        property: secret-key
    - secretKey: admin_password
      remoteRef:
        key: kubernetes/data/apps/harbor
        property: admin-password

---
# Registry secrets
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: vault-harbor-registry-secrets
  namespace: harbor
spec:
  refreshInterval: "1h"
  secretStoreRef:
    name: vault-cluster-secret-store
    kind: ClusterSecretStore
  target:
    name: harbor-registry-secret
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        REGISTRY_HTTP_SECRET: "{{ .http_secret }}"
  data:
    - secretKey: http_secret
      remoteRef:
        key: kubernetes/data/apps/harbor
        property: registry-http-secret
