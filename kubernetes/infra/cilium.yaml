---
# kubernetes/infra/cilium.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cilium
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "-100"
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  project: default
  source:
    repoURL: https://helm.cilium.io/
    chart: cilium
    targetRevision: 1.18.2
    helm:
      valuesObject:
        # Operator configuration - IMPORTANTE: suffix vuoto per Gateway API
        operator:
          replicas: 1
          image:
            # suffix: "-generic" -> usa operator-generic (NO Gateway API)
            # suffix: "" -> usa operator (CON Gateway API)
            suffix: ""
            useDigest: false
          prometheus:
            enabled: true
            port: 9963

        # Gateway API configuration
        gatewayAPI:
          enabled: true

        # IPAM configuration (dalla tua ConfigMap)
        ipam:
          mode: cluster-pool
          operator:
            clusterPoolIPv4PodCIDRList: ["10.0.0.0/8"]
            clusterPoolIPv4MaskSize: 24

        # Kubernetes API server
        k8sServiceHost: "192.168.0.80"
        k8sServicePort: "6443"

        # Routing mode (dalla tua ConfigMap)
        routingMode: tunnel
        tunnelProtocol: vxlan
        autoDirectNodeRoutes: false

        # kube-proxy replacement
        kubeProxyReplacement: false
        
        # L2 announcements
        l2announcements:
          enabled: false
        
        # Hubble (monitoring e observability)
        hubble:
          enabled: true
          relay:
            enabled: true
          ui:
            enabled: true
          tls:
            enabled: true

        # Prometheus metrics
        prometheus:
          enabled: true
          port: 9962

        # Cluster info
        cluster:
          name: kubernetes
          id: 0

        # Debug
        debug:
          enabled: false

        # Load Balancer IPAM
        # Gi√† abilitato di default con lbipam

  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system
  
  syncPolicy:
    automated:
      prune: false  # NON fare prune del CNI!
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
      - ServerSideApply=true
      - RespectIgnoreDifferences=true

  # Ignora differenze su ConfigMap gestito da Cilium
  ignoreDifferences:
    - group: ""
      kind: ConfigMap
      name: cilium-config
      jsonPointers:
        - /data
