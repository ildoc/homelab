---
# kubernetes/infra/cilium.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cilium
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  annotations:
    argocd.argoproj.io/sync-wave: "-100"  # Prima di tutto, è il CNI!
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  project: default
  source:
    repoURL: https://helm.cilium.io/
    chart: cilium
    targetRevision: 1.17.2
    helm:
      valuesObject:
        # Operator configuration - usa immagine completa con Gateway API
        operator:
          replicas: 1
          image:
            repository: quay.io/cilium/operator
            tag: v1.17.2
            useDigest: true
            digest: sha256:81f2d7198366e8dec2903a3a8361e4c68d47d19c68a0d42f0b7b6e3f0523f249
          prometheus:
            enabled: true
            port: 9963

        # Gateway API configuration
        gatewayAPI:
          enabled: true

        # Configurazioni dalla tua ConfigMap attuale
        ipam:
          mode: cluster-pool
          operator:
            clusterPoolIPv4PodCIDRList: ["10.0.0.0/8"]
            clusterPoolIPv4MaskSize: 24

        # Trova il tuo API server con: kubectl cluster-info
        k8sServiceHost: 192.168.0.80
        k8sServicePort: 6443

        # Routing
        routingMode: tunnel
        tunnelProtocol: vxlan
        autoDirectNodeRoutes: false

        # kube-proxy replacement (hai false)
        kubeProxyReplacement: false
        
        # LoadBalancer IPAM
        l2announcements:
          enabled: false  # Cambia a true se usi L2
        
        # Hubble (già abilitato)
        hubble:
          enabled: true
          relay:
            enabled: true
          ui:
            enabled: true
          tls:
            enabled: true

        # Prometheus metrics
        prometheus:
          enabled: true
          port: 9962

        # Cluster info
        cluster:
          name: kubernetes
          id: 0

        # Debug
        debug:
          enabled: false

  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system
  
  syncPolicy:
    automated:
      prune: false  # ATTENZIONE: non fare prune del CNI!
      selfHeal: true
    syncOptions:
      - CreateNamespace=false  # kube-system esiste già
      - ServerSideApply=true   # Importante per Cilium
      - RespectIgnoreDifferences=true

  # Ignora differenze su risorse gestite da Cilium stesso
  ignoreDifferences:
    - group: ""
      kind: ConfigMap
      name: cilium-config
      jsonPointers:
        - /data

---
# kubernetes/infra/manifests/cilium-gateway/values.yaml
# Questo file non serve più, la config è nell'Application sopra
# Ma lo teniamo vuoto per compatibilità con la struttura esistente
